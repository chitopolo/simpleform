<html>
<head>
    <title>Laboratorio - Ingreso de Resultados</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" >
</head>
<body>
  <br>
  <h4><p align="center">Resultados</p></h4>
  <br>
  <!-- Meter nombre del paciente aqui! -->
  <div id="fullNamePlace"></div>
  <br>
  <div id="doctorNameInput">Medico: <input id="doctorName"></input></div>
  <div id="doctorNameField"></div>
  <br>
  <div id="todayDate"></div>
  <br>
  <div id="allTheInputs" class="container" align="center"></div>
  <br>
  <br>
  <div id="confirmationDiv" align="center">
    <input type="checkbox" id="checkme"> Estoy seguro/a que los datos ingresados son correctos.</input>
  </div>

  <br>
  <div align = "center">
    <button  id="cancel" class="btn btn-danger hidden-print"> Salir</button>
    <button id="saveNow" class="btn btn-primary" disabled="true"> Guardar</button>
    <button id="showReport" class="btn btn-success hidden-print">Ver Reporte</button>
  </div>

  <script type="text/javascript">
    var checker = document.getElementById('checkme');
    var sendbtn = document.getElementById('saveNow');
    checker.onchange = function() {
      sendbtn.disabled = !this.checked;
    };
  </script>
  <br>
  <br>


<script src="js/jquery.js"></script>

<script>
    
$( document ).ready(function() {

    $('button#showReport').hide();

    var dataToSend
    $.urlParam = function(name){
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        return results[1] || 0;
    }

    var today = new Date();
    var dd = today.getDate();
    var mm = today.getMonth()+1; //January is 0!
    var yyyy = today.getFullYear();

    if(dd<10) {
        dd='0'+dd
    } 

    if(mm<10) {
        mm='0'+mm
    } 

    today = dd+'/'+mm+'/'+yyyy;

    $('#todayDate').text('Fecha: ' + today)

    var gotTheId = $.urlParam('id')
    var fullName = $.urlParam('fullName')
    var decodedUri = decodeURIComponent(fullName);
    $('#fullNamePlace').text('Nombre del Paciente: ' + decodedUri)
    var PathToURL = "http://localhost:3000/api/labTests/" + gotTheId

        $.ajax({
              type: 'GET',
              url: PathToURL,
              dataType: 'jsonp',
              success: function(data) {
                var stuff = data.LabTests;
                stuff.forEach(function(value){
                    console.log("value: ",value)
                    var minMax;
                    if (value.minVal) {
                      if (value.maxVal) {
                        minMax = value.minVal +' - '+ value.maxVal  
                      }
                      else {
                        minMax = "Mayor a " + value.minVal
                      }
                      
                    }
                    else {
                      if (value.maxVal) {
                        minMax = 'Hasta '+ value.maxVal
                      }
                      else {
                        if (value.referenceVal) {
                          minMax = value.referenceVal
                        }
                        else {
                          minMax = ''
                        }
                      }
                    }
                    minMax = minMax + ' ' + value.unit
                    $('#allTheInputs')
                    .append($('<div class="row"/>')
                         .append($('<div class="col-md-3"/>').append($('<h5/>', {
                            text: value.name,
                            })))
                        .append($('<div class="col-md-2"/>')
                         .append($('<input/>', {
                                id: value.id,
                                name: value.name,
                                class: minMax
                        }))).append($('<div class="col-md-3" align="right"/>')
                         .append($('<p/>',{
                            text: minMax
                        }))))
                        
                })
              }
          })

    $('#saveNow').on('click', function(){
        var doctorName = $('#doctorName').val()
        var PathToURL = "http://localhost:3000/api/labAnalysis"

        var chunk = [];

         $('#allTheInputs :input').each(function(){
          var input = $(this); // This is the jquery object of the input, do what you will
          console.log("input->", input.val() , ' with input ', input)
          var value = {
            idTest: input[0].id,
            valueTest: input.val() || -1,
            name: input[0].name,
            range: input[0].className
          }
          chunk.push(value)
         });

         dataToSend = {
            patientId: gotTheId,
            testResults: chunk,
            doctorName: doctorName
         }
         console.log("data to send:", dataToSend)
        $.ajax({
          method: "POST",
          url: PathToURL,
          data: dataToSend
        }).done(function( msg ) {
          document.getElementById('confirmationDiv').style.display = 'none'
            alert( "Datos de laboratorio guardados");
      });
    $('button#showReport').show();
    $('button#saveNow').hide();
    });


    $('#showReport').on('click', function(){

        $('#allTheInputs').empty();
        var doctorNameValue = $('#doctorName').val()
        $('#doctorNameField').text('Medico: ' + doctorNameValue)
        document.getElementById('doctorNameInput').style.display = 'none'
         var creatingInputs = dataToSend.testResults;
        console.log("The data:", dataToSend.testResults);
        creatingInputs.forEach(function(value){
            if(value.valueTest!== -1){
                $('#allTheInputs')
                .append($('<div class="row-fluid"/>')
                    .append($('<div class="col-sm-4"/>')
                         .append($('<h5/>',{text:value.name})))
                            .append($('<div class="col-sm-4"/>')
                         .append($('<h5/>',{text:value.valueTest})))
                            .append($('<div class="col-sm-4"/>')
                         .append($('<h5/>',{text:value.range}))))
                    
            }
        })


    $('button#showReport').hide();
    $('button#cancel').text('Volver al Menu');
    })

    $('button#cancel').on('click', function(){
        
        if(confirm('Esta seguro que desea salir al menu principal?')){
            $(location).attr('href','index.html');
        }

    });


})



</script>
</body>
</html>